<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Conciergerie ‚Äì Gestion des missions</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#0f1117;color:#e8eaf2;font-family:'DM Sans',sans-serif;min-height:100vh;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-thumb{background:#2a2f45;border-radius:3px;}
a{text-decoration:none;}
input,textarea,select{background:#0f1117;border:1px solid #2a2f45;border-radius:8px;padding:10px 14px;color:#e8eaf2;font-size:14px;font-family:'DM Sans',sans-serif;outline:none;width:100%;box-sizing:border-box;transition:border-color .2s;}
input:focus,textarea:focus,select:focus{border-color:#4f8ef7;}
textarea{resize:vertical;min-height:80px;}
select{cursor:pointer;}
select option{background:#1a1d27;}
label{font-size:12px;color:#8891b0;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:6px;}
.field{display:flex;flex-direction:column;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
button{border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:opacity .15s;border:none;}
button:hover{opacity:.8;}
.btn-primary{background:#4f8ef7;color:#fff;padding:10px 18px;font-size:14px;}
.btn-secondary{background:transparent;color:#8891b0;border:1px solid #2a2f45 !important;padding:10px 18px;font-size:14px;}
.btn-success{background:#2dd4a0;color:#0a1f17;padding:10px 18px;font-size:14px;}
.btn-danger{background:transparent;color:#f75f5f;border:1px solid #f75f5f33 !important;padding:6px 12px;font-size:12px;}
.btn-sm{padding:6px 12px !important;font-size:12px !important;}
.btn-gcal{background:#1a73e822;color:#4f9ef8;border:1px solid #1a73e844 !important;padding:7px 12px;font-size:12px;white-space:nowrap;border-radius:8px;font-weight:600;font-family:'DM Sans',sans-serif;display:inline-flex;align-items:center;gap:5px;}
.card{background:#1a1d27;border:1px solid #2a2f45;border-radius:12px;padding:20px;}
.badge{border-radius:6px;padding:3px 10px;font-size:12px;font-family:'DM Mono',monospace;font-weight:600;}
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
#login-box{background:#1a1d27;border:1px solid #2a2f45;border-radius:20px;padding:40px;width:100%;max-width:380px;text-align:center;}
#login-box h1{font-family:'Fraunces',serif;font-size:24px;margin-bottom:6px;}
#login-box p{color:#8891b0;font-size:14px;margin-bottom:28px;}
#login-pwd{text-align:center;font-size:16px;letter-spacing:.2em;margin-bottom:12px;}
#login-err{color:#f75f5f;font-size:13px;margin-bottom:8px;display:none;}
#header{border-bottom:1px solid #2a2f45;background:#1a1d27;}
#header-top{max-width:900px;margin:0 auto;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
#header-top h1{font-family:'Fraunces',serif;font-size:24px;letter-spacing:-.02em;}
#header-top p{font-size:13px;color:#8891b0;margin-top:2px;}
#tabs{max-width:900px;margin:0 auto;padding:0 24px;display:flex;gap:4px;}
.tab-btn{background:none;border:none !important;padding:10px 16px;font-size:14px;font-family:'DM Sans',sans-serif;font-weight:600;color:#8891b0;border-bottom:2px solid transparent !important;cursor:pointer;border-radius:0;}
.tab-btn.active{color:#4f8ef7;border-bottom:2px solid #4f8ef7 !important;}
#main{max-width:900px;margin:0 auto;padding:28px 24px;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}
.mission-card{display:flex;align-items:flex-start;gap:16px;padding:16px 20px;flex-wrap:wrap;margin-bottom:10px;}
.mission-date{min-width:52px;text-align:center;flex-shrink:0;}
.mission-date .dm{font-size:11px;font-family:'DM Mono',monospace;color:#5a6280;text-transform:uppercase;}
.mission-date .dn{font-size:26px;font-weight:700;line-height:1;}
.mission-date .dw{font-size:11px;color:#5a6280;}
.mission-info{flex:1;min-width:180px;}
.mission-meta{display:flex;gap:16px;margin-top:6px;flex-wrap:wrap;}
.mission-meta span{font-size:12px;color:#5a6280;}
.mission-meta .cost{color:#f7a94f;font-family:'DM Mono',monospace;font-weight:600;}
.mission-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
.prest-card{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:10px;}
.prest-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0;}
.log-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
.log-code{background:#0f1117;border-radius:6px;padding:6px 10px;font-family:'DM Mono',monospace;font-size:13px;color:#f7a94f;margin-bottom:8px;}
#modal-overlay{position:fixed;inset:0;background:#00000088;z-index:1000;display:none;align-items:center;justify-content:center;padding:20px;}
#modal-overlay.open{display:flex;}
#modal-box{background:#1a1d27;border:1px solid #2a2f45;border-radius:16px;padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;}
#modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
#modal-header h3{font-family:'Fraunces',serif;font-size:20px;}
#modal-close{background:none;border:none !important;color:#8891b0;font-size:20px;cursor:pointer;padding:0;}
.modal-form{display:flex;flex-direction:column;gap:14px;}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:4px;}
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
.color-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .15s;}
.color-dot.sel{border-color:white;}
#toast{position:fixed;top:20px;right:20px;z-index:2000;border-radius:10px;padding:12px 20px;font-weight:600;font-size:14px;display:none;}
.info-box{background:#1e2d4d;border:1px solid #4f8ef733;border-radius:12px;padding:20px;margin-top:24px;}
.info-box h4{color:#7aaeff;font-family:'Fraunces',serif;margin-bottom:8px;}
.info-box p{font-size:13px;color:#8891b0;line-height:1.7;}
.empty{text-align:center;padding:48px;}
.empty-icon{font-size:40px;margin-bottom:12px;}
#filter-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap;}
#filter-sel{background:#1a1d27;border:1px solid #2a2f45;border-radius:8px;padding:8px 12px;color:#e8eaf2;font-size:13px;font-family:'DM Sans',sans-serif;cursor:pointer;width:auto;min-width:200px;}
</style>
</head>
<body>

<div id="login-screen">
  <div id="login-box">
    <div style="font-size:48px;margin-bottom:16px">üè°</div>
    <h1>Conciergerie</h1>
    <p>Acc√®s priv√© ‚Äî Entrez votre mot de passe</p>
    <input type="password" id="login-pwd" placeholder="Mot de passe"/>
    <div id="login-err">Mot de passe incorrect</div>
    <button class="btn-primary" style="width:100%;justify-content:center;margin-top:4px" onclick="doLogin()">Acc√©der ‚Üí</button>
  </div>
</div>

<div id="app" style="display:none">
  <div id="toast"></div>
  <div id="header">
    <div id="header-top">
      <div>
        <h1>üè° Conciergerie</h1>
        <p>Gestion des missions & calendriers prestataires</p>
      </div>
      <div style="display:flex;gap:8px">
        <span id="b-missions" class="badge" style="background:#4f8ef722;color:#4f8ef7;border:1px solid #4f8ef744"></span>
        <span id="b-prests" class="badge" style="background:#2dd4a022;color:#2dd4a0;border:1px solid #2dd4a044"></span>
      </div>
    </div>
    <div id="tabs">
      <button class="tab-btn active" onclick="showTab('missions',this)">üìÖ Missions</button>
      <button class="tab-btn" onclick="showTab('prests',this)">üë§ Prestataires</button>
      <button class="tab-btn" onclick="showTab('logs',this)">üè° Logements</button>
    </div>
  </div>
  <div id="main">
    <div id="tab-missions" class="tab-panel active">
      <div id="filter-bar">
        <select id="filter-sel" onchange="renderMissions()"><option value="all">Tous les prestataires</option></select>
        <button class="btn-primary" onclick="openModal('mission')">+ Nouvelle mission</button>
      </div>
      <div id="list-missions"></div>
    </div>
    <div id="tab-prests" class="tab-panel">
      <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
        <button class="btn-primary" onclick="openModal('prest')">+ Ajouter un prestataire</button>
      </div>
      <div id="list-prests"></div>
      <div class="info-box"><h4>üí° Workflow recommand√©</h4><p>1. Cr√©e un <strong style="color:#e8eaf2">Google Calendar par prestataire</strong> dans ton compte Google.<br/>2. Partage-lui le <strong style="color:#e8eaf2">lien d'abonnement</strong> une seule fois.<br/>3. Pour chaque mission, clique <strong style="color:#e8eaf2">"Ajouter √† Google Cal"</strong> et choisis le bon calendrier ‚Üí √ßa appara√Æt chez le prestataire.</p></div>
    </div>
    <div id="tab-logs" class="tab-panel">
      <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
        <button class="btn-primary" onclick="openModal('log')">+ Ajouter un logement</button>
      </div>
      <div id="list-logs" class="log-grid"></div>
    </div>
  </div>
</div>

<div id="modal-overlay" onclick="closeModal()">
  <div id="modal-box" onclick="event.stopPropagation()">
    <div id="modal-header">
      <h3 id="modal-title"></h3>
      <button id="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
const EMAILJS_SERVICE="service_l8txlj7";
const EMAILJS_TEMPLATE="template_k8lprcs";
const EMAILJS_KEY="_tN4-qAXFb2FiEpvT";
const GCAL_CLIENT_ID="589607226482-3923o1fdtc61utrnre50ieovmuolq1oq.apps.googleusercontent.com";
const GCAL_SCOPES="https://www.googleapis.com/auth/calendar.events";
const MDP="conciergerie2024";

let gisLoaded=false, gapiLoaded=false, tokenClient=null, accessToken=null;

function initGoogleAPI(){
  gapi.load("client", async()=>{
    await gapi.client.init({discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]});
    gapiLoaded=true;
  });
}

function loadGIS(){
  const s=document.createElement("script");
  s.src="https://accounts.google.com/gsi/client";
  s.onload=()=>{
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:GCAL_CLIENT_ID,
      scope:GCAL_SCOPES,
      callback:(resp)=>{
        if(resp.error)return;
        accessToken=resp.access_token;
        if(pendingMission){addToGcal(pendingMission);pendingMission=null;}
      }
    });
    gisLoaded=true;
  };
  document.head.appendChild(s);
}

let pendingMission=null;

async function addToGcal(m){
  const pr=S.prests.find(p=>p.id===m.prestataireId),lo=S.logs.find(l=>l.id===m.logementId);
  if(!pr?.calendarId){showToast("Ajoutez l'ID du calendrier dans la fiche prestataire","#f7a94f");return;}
  if(!accessToken){
    pendingMission=m;
    tokenClient.requestAccessToken({prompt:"consent"});
    return;
  }
  const startDt=`${m.date}T${m.heureMission||"09:00"}:00`;
  const endDt=`${m.date}T${m.heureMission||"09:00"}:00`;
  const desc=["üë§ "+pr.nom,"üîë Code : "+(lo?.codeAcces||""),m.heureDepart?"üõ´ D√©part locataires : "+m.heureDepart:"",m.dateArrivee?"üõ¨ Arriv√©e prochains : "+m.dateArrivee+(m.heureArrivee?" √† "+m.heureArrivee:""):"",m.cout?"üí∂ Co√ªt : "+m.cout:"",m.consignes?"üìù "+m.consignes:""].filter(Boolean).join("\n");
  try{
    await gapi.client.calendar.events.insert({
      calendarId: pr.calendarId,
      resource:{
        summary:"üßπ M√©nage ‚Äì "+(lo?.nom||""),
        description:desc,
        location:lo?.adresse||"",
        start:{dateTime:startDt,timeZone:"Europe/Paris"},
        end:{dateTime:endDt,timeZone:"Europe/Paris"},
      }
    });
    showToast("‚úÖ Ajout√© dans le calendrier de "+pr.nom);
  }catch(e){
    accessToken=null;
    showToast("Erreur calendrier ‚Äî reconnecte-toi","#f75f5f");
  }
}
const COLS=["#4f8ef7","#2dd4a0","#f7a94f","#f75f9f","#a78bfa","#f75f5f"];
let S={prests:[{id:"p1",nom:"Marie Dupont",email:"marie@example.com",couleur:"#4f8ef7"},{id:"p2",nom:"Thomas Bernard",email:"thomas@example.com",couleur:"#2dd4a0"}],logs:[{id:"l1",nom:"Villa Les Pins",adresse:"12 Rue des Mimosas, Antibes",codeAcces:"A1234#",notes:""},{id:"l2",nom:"Appart Vue Mer",adresse:"8 Boulevard de la Plage, Nice",codeAcces:"B5678*",notes:""}],missions:[]};
let mType=null,eId=null,selCol="#4f8ef7";

function doLogin(){
  if(document.getElementById("login-pwd").value===MDP){
    localStorage.setItem("conc_auth","1");
    document.getElementById("login-screen").style.display="none";
    document.getElementById("app").style.display="block";
    loadData();render();
  }else{
    const e=document.getElementById("login-err");e.style.display="block";
    setTimeout(()=>e.style.display="none",2000);
    document.getElementById("login-pwd").value="";
  }
}
document.getElementById("login-pwd").addEventListener("keydown",e=>{if(e.key==="Enter")doLogin();});

function loadData(){try{const p=localStorage.getItem("conc_prests");if(p)S.prests=JSON.parse(p);const l=localStorage.getItem("conc_logs");if(l)S.logs=JSON.parse(l);const m=localStorage.getItem("conc_missions");if(m)S.missions=JSON.parse(m);}catch{}}
function persist(){try{localStorage.setItem("conc_prests",JSON.stringify(S.prests));localStorage.setItem("conc_logs",JSON.stringify(S.logs));localStorage.setItem("conc_missions",JSON.stringify(S.missions));}catch{}}

if(localStorage.getItem("conc_auth")==="1"){document.getElementById("login-screen").style.display="none";document.getElementById("app").style.display="block";loadData();}

function showTab(tab,btn){
  document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("tab-"+tab).classList.add("active");
  btn.classList.add("active");render();
}

function showToast(msg,color="#2dd4a0"){
  const t=document.getElementById("toast");
  t.textContent=msg;t.style.background=color+"22";t.style.border="1px solid "+color+"55";t.style.color=color;t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

function gcalUrl(m){
  const pr=S.prests.find(p=>p.id===m.prestataireId),lo=S.logs.find(l=>l.id===m.logementId);
  const fmt=(d,t)=>new Date(`${d}T${t||"09:00"}`).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const title=encodeURIComponent("üßπ M√©nage ‚Äì "+(lo?.nom||""));
  const det=encodeURIComponent(["üë§ "+(pr?.nom||""),"üîë Code : "+(lo?.codeAcces||""),m.heureDepart?"üõ´ D√©part : "+m.heureDepart:"",m.dateArrivee?"üõ¨ Arriv√©e prochains : "+m.dateArrivee+(m.heureArrivee?" √† "+m.heureArrivee:""):"",m.cout?"üí∂ Co√ªt : "+m.cout:"",m.consignes?"üìù "+m.consignes:""].filter(Boolean).join("\n"));
  return`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${fmt(m.date,m.heureMission)}/${fmt(m.date,m.heureMission)}&details=${det}&location=${encodeURIComponent(lo?.adresse||"")}`;
}

function downloadIcal(prestId){
  const pr=S.prests.find(p=>p.id===prestId);
  const esc=s=>(s||"").replace(/[,;\\]/g,"\\$&").replace(/\n/g,"\\n");
  const fmt=(d,t)=>new Date(`${d}T${t||"09:00"}`).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const evts=S.missions.filter(m=>m.prestataireId===prestId).map(m=>{
    const lo=S.logs.find(l=>l.id===m.logementId);
    const desc=["üìç "+(lo?.adresse||""),"üîë "+(lo?.codeAcces||""),m.heureDepart?"üõ´ D√©part : "+m.heureDepart:"",m.dateArrivee?"üõ¨ Arriv√©e prochains : "+m.dateArrivee+(m.heureArrivee?" √† "+m.heureArrivee:""):"",m.cout?"üí∂ Co√ªt : "+m.cout:"",m.consignes?"üìù "+m.consignes:""].filter(Boolean).join("\\n");
    return["BEGIN:VEVENT","UID:"+m.id+"@conciergerie","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").split(".")[0]+"Z","DTSTART:"+fmt(m.date,m.heureMission),"DTEND:"+fmt(m.date,m.heureMission),"SUMMARY:"+esc("üßπ M√©nage ‚Äì "+(lo?.nom||"")),"DESCRIPTION:"+esc(desc),"LOCATION:"+esc(lo?.adresse||""),"END:VEVENT"].join("\r\n");
  });
  const ical=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Conciergerie//FR","X-WR-CALNAME:Missions ‚Äì "+pr.nom,"CALSCALE:GREGORIAN","METHOD:PUBLISH",...evts,"END:VCALENDAR"].join("\r\n");
  const blob=new Blob([ical],{type:"text/calendar;charset=utf-8"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="missions-"+pr.nom.replace(/\s+/g,"_")+".ics";a.click();URL.revokeObjectURL(url);
  showToast("Calendrier t√©l√©charg√© ‚úì");
}

function render(){
  document.getElementById("b-missions").textContent=S.missions.length+" missions";
  document.getElementById("b-prests").textContent=S.prests.length+" prestataires";
  const fs=document.getElementById("filter-sel"),fv=fs.value;
  fs.innerHTML='<option value="all">Tous les prestataires</option>'+S.prests.map(p=>`<option value="${p.id}">${p.nom}</option>`).join("");
  fs.value=fv;
  renderMissions();renderPrests();renderLogs();
}

function renderMissions(){
  const fv=document.getElementById("filter-sel").value;
  let ms=[...S.missions].sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(fv!=="all")ms=ms.filter(m=>m.prestataireId===fv);
  const el=document.getElementById("list-missions");
  if(!ms.length){el.innerHTML=`<div class="card empty"><div class="empty-icon">üìÖ</div><p style="color:#8891b0;margin-bottom:16px">Aucune mission pour l'instant</p><button class="btn-primary" onclick="openModal('mission')">Cr√©er la premi√®re mission</button></div>`;return;}
  el.innerHTML=ms.map(m=>{
    const pr=S.prests.find(p=>p.id===m.prestataireId),lo=S.logs.find(l=>l.id===m.logementId);
    const d=new Date(m.date+"T12:00:00");
    const dm=d.toLocaleDateString("fr-FR",{month:"short"}).toUpperCase();
    const dn=d.getDate(),dw=d.toLocaleDateString("fr-FR",{weekday:"short"});
    const badge=pr?`<span class="badge" style="background:${pr.couleur}22;color:${pr.couleur};border:1px solid ${pr.couleur}44">${pr.nom}</span>`:"";
    const arrDate=m.dateArrivee?new Date(m.dateArrivee+"T12:00:00").toLocaleDateString("fr-FR",{day:"numeric",month:"short"}):"";
    return`<div class="card mission-card">
      <div class="mission-date"><div class="dm">${dm}</div><div class="dn">${dn}</div><div class="dw">${dw}</div></div>
      <div class="mission-info">
        <div style="font-weight:600;font-size:15px;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">${lo?.nom||"?"} ${badge}</div>
        <div style="font-size:13px;color:#8891b0">${lo?.adresse||""}</div>
        <div class="mission-meta">
          ${m.heureMission?`<span>üßπ D√©but ${m.heureMission}</span>`:""}
          ${m.heureDepart?`<span>üõ´ D√©part ${m.heureDepart}</span>`:""}
          ${m.dateArrivee?`<span>üõ¨ Arriv√©e le ${arrDate}${m.heureArrivee?" √† "+m.heureArrivee:""}</span>`:""}
          ${m.cout?`<span class="cost">üí∂ ${m.cout}</span>`:""}
        </div>
        ${m.consignes?`<div style="font-size:12px;color:#5a6280;margin-top:4px;font-style:italic">üìù ${m.consignes.substring(0,80)}${m.consignes.length>80?"‚Ä¶":""}</div>`:""}
      </div>
      <div class="mission-actions">
        <a href="${gcalUrl(m)}" target="_blank" class="btn-gcal">üìÖ Ajouter √† Google Cal</a>
        <div style="display:flex;gap:6px">
          <button class="btn-secondary btn-sm" onclick="openModal('mission','${m.id}')">‚úèÔ∏è</button>
          <button class="btn-danger" onclick="delMission('${m.id}')">‚úï</button>
        </div>
      </div>
    </div>`;
  }).join("");
}

function renderPrests(){
  const el=document.getElementById("list-prests");
  if(!S.prests.length){el.innerHTML=`<div class="card empty"><div class="empty-icon">üë§</div><p style="color:#8891b0">Aucun prestataire</p></div>`;return;}
  el.innerHTML=S.prests.map(p=>{
    const c=S.missions.filter(m=>m.prestataireId===p.id).length;
    return`<div class="card prest-card">
      <div class="prest-avatar" style="background:${p.couleur}33;border:2px solid ${p.couleur};color:${p.couleur}">${p.nom.charAt(0).toUpperCase()}</div>
      <div style="flex:1;min-width:120px"><div style="font-weight:600;font-size:15px">${p.nom}</div><div style="font-size:13px;color:#8891b0">${p.email}</div></div>
      <span class="badge" style="background:#4f8ef722;color:#4f8ef7;border:1px solid #4f8ef744">${c} mission${c!==1?"s":""}</span>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn-success btn-sm" onclick="downloadIcal('${p.id}')">‚¨á .ics</button>
        <button class="btn-secondary btn-sm" onclick="openModal('prest','${p.id}')">‚úèÔ∏è</button>
        <button class="btn-danger" onclick="delPrest('${p.id}')">‚úï</button>
      </div>
    </div>`;
  }).join("");
}

function renderLogs(){
  const el=document.getElementById("list-logs");
  if(!S.logs.length){el.innerHTML=`<div class="card empty"><div class="empty-icon">üè°</div><p style="color:#8891b0">Aucun logement</p></div>`;return;}
  el.innerHTML=S.logs.map(l=>{
    const c=S.missions.filter(m=>m.logementId===l.id).length;
    return`<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px"><span style="font-size:28px">üè°</span><span class="badge" style="background:#f7a94f22;color:#f7a94f;border:1px solid #f7a94f44">${c} mission${c!==1?"s":""}</span></div>
      <div style="font-weight:700;font-size:16px;margin-bottom:4px">${l.nom}</div>
      <div style="font-size:13px;color:#8891b0;margin-bottom:8px">üìç ${l.adresse}</div>
      ${l.codeAcces?`<div class="log-code">üîë ${l.codeAcces}</div>`:""}
      ${l.notes?`<div style="font-size:12px;color:#5a6280;font-style:italic;margin-bottom:8px">${l.notes}</div>`:""}
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn-secondary btn-sm" onclick="openModal('log','${l.id}')">‚úèÔ∏è Modifier</button>
        <button class="btn-danger" onclick="delLog('${l.id}')">‚úï</button>
      </div>
    </div>`;
  }).join("");
}

function delMission(id){S.missions=S.missions.filter(m=>m.id!==id);persist();renderMissions();document.getElementById("b-missions").textContent=S.missions.length+" missions";showToast("Mission supprim√©e","#f75f5f");}
function delPrest(id){S.prests=S.prests.filter(p=>p.id!==id);persist();render();}
function delLog(id){S.logs=S.logs.filter(l=>l.id!==id);persist();renderLogs();}

function openModal(type,id=null){
  mType=type;eId=id;
  const title=document.getElementById("modal-title"),body=document.getElementById("modal-body");
  if(type==="mission"){
    const m=id?S.missions.find(x=>x.id===id):null;
    title.textContent=m?"Modifier la mission":"Nouvelle mission";
    const today=new Date().toISOString().split("T")[0];
    body.innerHTML=`<div class="modal-form">
      <div class="field"><label>Prestataire</label><select id="f-prest">${S.prests.map(p=>`<option value="${p.id}"${m?.prestataireId===p.id?" selected":""}>${p.nom}</option>`).join("")}</select></div>
      <div class="field"><label>Logement</label><select id="f-log">${S.logs.map(l=>`<option value="${l.id}"${m?.logementId===l.id?" selected":""}>${l.nom}</option>`).join("")}</select></div>
      <div class="field"><label>Date de la mission</label><input type="date" id="f-date" value="${m?.date||today}"/></div>
      <div class="grid2">
        <div class="field"><label>Heure d√©but m√©nage</label><input type="time" id="f-heure" value="${m?.heureMission||"09:00"}"/></div>
        <div class="field"><label>D√©part locataires</label><input type="time" id="f-dep" value="${m?.heureDepart||""}"/></div>
      </div>
      <div class="grid2">
        <div class="field"><label>Date arriv√©e prochains locataires</label><input type="date" id="f-datearr" value="${m?.dateArrivee||""}"/></div>
        <div class="field"><label>Heure d'arriv√©e</label><input type="time" id="f-hearr" value="${m?.heureArrivee||""}"/></div>
      </div>
      <div class="field"><label>Co√ªt de la prestation</label><input type="text" id="f-cout" placeholder="ex : 75‚Ç¨ forfait / 3h √ó 20‚Ç¨" value="${m?.cout||""}"/></div>
      <div class="field"><label>Consignes sp√©cifiques</label><textarea id="f-consignes" placeholder="Changer les draps ch.1 et 2, inventaire cuisine...">${m?.consignes||""}</textarea></div>
      <div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Annuler</button><button class="btn-primary" onclick="saveMission()">${m?"Mettre √† jour":"Cr√©er la mission"}</button></div>
    </div>`;
  }
  if(type==="prest"){
    const p=id?S.prests.find(x=>x.id===id):null;
    selCol=p?.couleur||"#4f8ef7";
    title.textContent=p?"Modifier le prestataire":"Nouveau prestataire";
    body.innerHTML=`<div class="modal-form">
      <div class="field"><label>Nom complet</label><input type="text" id="f-nom" placeholder="Marie Dupont" value="${p?.nom||""}"/></div>
      <div class="field"><label>Email</label><input type="email" id="f-email" placeholder="marie@example.com" value="${p?.email||""}"/></div>
      <div class="field"><label>ID Calendrier Google</label><input type="text" id="f-calid" placeholder="xxxxxx@group.calendar.google.com" value="${p?.calendarId||""}"/><span style="font-size:11px;color:#5a6280;margin-top:4px">Param√®tres du calendrier Google ‚Üí Int√©grer l'agenda ‚Üí ID de l'agenda</span></div>
      <div class="field"><label>Couleur</label><div class="color-picker">${COLS.map(c=>`<div class="color-dot${c===selCol?" sel":""}" style="background:${c}" onclick="pickCol('${c}',this)"></div>`).join("")}</div></div>
      <div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Annuler</button><button class="btn-primary" onclick="savePrest()">${p?"Mettre √† jour":"Ajouter"}</button></div>
    </div>`;
  }
  if(type==="log"){
    const l=id?S.logs.find(x=>x.id===id):null;
    title.textContent=l?"Modifier le logement":"Nouveau logement";
    body.innerHTML=`<div class="modal-form">
      <div class="field"><label>Nom du logement</label><input type="text" id="f-nom" placeholder="Villa Les Pins" value="${l?.nom||""}"/></div>
      <div class="field"><label>Adresse compl√®te</label><input type="text" id="f-adr" placeholder="12 Rue des Mimosas, 06600 Antibes" value="${l?.adresse||""}"/></div>
      <div class="field"><label>Code d'acc√®s / cl√©s</label><input type="text" id="f-code" placeholder="A1234# ‚Äî bo√Æte √† cl√©s sous le porche" value="${l?.codeAcces||""}"/></div>
      <div class="field"><label>Notes permanentes</label><textarea id="f-notes" placeholder="Consignes g√©n√©rales valables √† chaque passage...">${l?.notes||""}</textarea></div>
      <div class="modal-actions"><button class="btn-secondary" onclick="closeModal()">Annuler</button><button class="btn-primary" onclick="saveLog()">${l?"Mettre √† jour":"Ajouter"}</button></div>
    </div>`;
  }
  document.getElementById("modal-overlay").classList.add("open");
}

function closeModal(){document.getElementById("modal-overlay").classList.remove("open");}
function pickCol(c,el){selCol=c;document.querySelectorAll(".color-dot").forEach(d=>d.classList.remove("sel"));el.classList.add("sel");}

function sendEmail(m){
  const pr=S.prests.find(p=>p.id===m.prestataireId),lo=S.logs.find(l=>l.id===m.logementId);
  if(!pr?.email){showToast("Pas d'email pour ce prestataire","#f7a94f");return;}
  const dateStr=new Date(m.date+"T12:00:00").toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
  const dateArrStr=m.dateArrivee?new Date(m.dateArrivee+"T12:00:00").toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}):"‚Äî";
  emailjs.init(EMAILJS_KEY);
  emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, {
    email_prestataire: pr.email,
    prestataire: pr.nom,
    logement: lo?.nom||"",
    date: dateStr,
    heure_debut: m.heureMission||"‚Äî",
    heure_depart: m.heureDepart||"‚Äî",
    date_arrivee: dateArrStr,
    heure_arrivee: m.heureArrivee||"‚Äî",
    cout: m.cout||"‚Äî",
    code_acces: lo?.codeAcces||"‚Äî",
    consignes: m.consignes||"‚Äî",
  }).then(()=>showToast("Email envoy√© √† "+pr.nom+" ‚úì")).catch(()=>showToast("Erreur envoi email","#f75f5f"));
}

function saveMission(){
  const pId=document.getElementById("f-prest")?.value,lId=document.getElementById("f-log")?.value,date=document.getElementById("f-date")?.value;
  if(!pId||!lId||!date)return;
  const m={id:eId||"m"+Date.now(),prestataireId:pId,logementId:lId,date,heureMission:document.getElementById("f-heure")?.value||"",heureDepart:document.getElementById("f-dep")?.value||"",dateArrivee:document.getElementById("f-datearr")?.value||"",heureArrivee:document.getElementById("f-hearr")?.value||"",cout:document.getElementById("f-cout")?.value||"",consignes:document.getElementById("f-consignes")?.value||""};
  const isNew=!eId;
  if(eId)S.missions=S.missions.map(x=>x.id===eId?m:x);else S.missions.push(m);
  persist();closeModal();render();
  showToast(isNew?"Mission cr√©√©e ‚úì ‚Äî ajout au calendrier...":"Mission mise √† jour ‚úì");
  if(isNew){sendEmail(m);addToGcal(m);}
}
function savePrest(){
  const nom=document.getElementById("f-nom")?.value;if(!nom)return;
  const p={id:eId||"p"+Date.now(),nom,email:document.getElementById("f-email")?.value||"",calendarId:document.getElementById("f-calid")?.value||"",couleur:selCol};
  if(eId)S.prests=S.prests.map(x=>x.id===eId?p:x);else S.prests.push(p);
  persist();closeModal();render();showToast("Prestataire enregistr√© ‚úì");
}
function saveLog(){
  const nom=document.getElementById("f-nom")?.value;if(!nom)return;
  const l={id:eId||"l"+Date.now(),nom,adresse:document.getElementById("f-adr")?.value||"",codeAcces:document.getElementById("f-code")?.value||"",notes:document.getElementById("f-notes")?.value||""};
  if(eId)S.logs=S.logs.map(x=>x.id===eId?l:x);else S.logs.push(l);
  persist();closeModal();render();showToast("Logement enregistr√© ‚úì");
}

if(localStorage.getItem("conc_auth")==="1")render();

// Init Google APIs
window.addEventListener("load",()=>{
  if(typeof gapi!=="undefined")initGoogleAPI();
  loadGIS();
});
</script>
</body>
</html>
